#cloud-config

# Install .NET Runtime 8.0
runcmd:
  # Register Microsoft repository (which includes .NET Runtime 8.0 package)
  - wget -q https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
  - dpkg -i packages-microsoft-prod.deb

  # Install .NET Runtime 8.0
  - apt-get update
  - apt-get install -y aspnetcore-runtime-8.0

  # Install GitHub Actions Runner
  - mkdir /home/azureuser/actions-runner && cd /home/azureuser/actions-runner
  - curl -o actions-runner-linux-x64-2.319.1.tar.gz -L https://github.com/actions/runner/releases/download/v2.319.1/actions-runner-linux-x64-2.319.1.tar.gz
  - echo "3f6efb7488a183e291fc2c62876e14c9ee732864173734facc85a1bfb1744464  actions-runner-linux-x64-2.319.1.tar.gz" | shasum -a 256 -c
  - tar xzf ./actions-runner-linux-x64-2.319.1.tar.gz

  # Set up GitHub Actions Runner
  - ./config.sh --url https://github.com/YOUR-ORG/YOUR-REPO --token YOUR_ACCESS_TOKEN --unattended --name self-hosted-runner --replace

  # Start the runner service
  - ./svc.sh install
  - ./svc.sh start

write_files:
  - path: /etc/systemd/system/webapp.service
    content: |
      [Unit]
      Description=ASP.NET Web App running on Ubuntu

      [Service]
      WorkingDirectory=/opt/webapp
      ExecStart=/usr/bin/dotnet /opt/webapp/webapp.dll
      Restart=always
      RestartSec=10
      KillSignal=SIGINT
      SyslogIdentifier=webapp
      User=www-data
      Environment=ASPNETCORE_ENVIRONMENT=Production
      Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false
      Environment="ASPNETCORE_URLS=http://*:5000"

      [Install]
      WantedBy=multi-user.target
    owner: root:root
    permissions: '0644'

systemd:
  units:
    - name: webapp.service
      enabled: true





eval $(ssh-agent)
ssh-add
ssh -A username@IPBastionHost